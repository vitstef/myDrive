name: myDrive Docker CI

on:
  push:
    branches: [ mydrive-GCloudRun ]
    
env:
  PROJECT_ID: 'just-student-344815'
  GAR_LOCATION: 'us-central1'
  SERVICE: 'github-docker-repo'
  REGION: 'us-central1'

jobs:

  build:

    runs-on: ubuntu-latest
    
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
    
    - uses: actions/checkout@v2
    
#    - name: Import GPG key
#      id: import_gpg
#      uses: hashicorp/ghaction-import-gpg@v2.1.0
#      env:
#        GPG_PRIVATE_KEY: ${{ secrets.GPG_SIGNING_KEY }}
#        PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
#    - run: |
#          gpg -v --quiet --yes --decrypt --passphrase=${{ secrets.GPG_PASSPHRASE }} --output docker-variables.env docker-variables.env.gpg
#    - name: Create volume for Mongo
#      run: docker volume create --name=mongodb_data_volume
    - name: Build the Docker image and push to registry
      run: | 
          docker build .
          echo ${{ secrets.PAT }} | docker login ghcr.io --username vitstef --password-stdin
          docker tag mydrive_app ghcr.io/vitstef/mydrive_app:latest
          docker push ghcr.io/vitstef/mydrive_app:latest

    - name: Google Auth
      id: auth
      uses: 'google-github-actions/auth@v0'
      with:
        token_format: 'access_token'
        workload_identity_provider: '${{ secrets.WIF_PROVIDER }}'
        service_account: '${{ secrets.WIF_SERVICE_ACCOUNT }}' 
        
      # BEGIN - Docker auth and build (NOTE: If you already have a container image, these Docker steps can be omitted)

      # Authenticate Docker to Google Cloud Artifact Registry
    - name: Docker Auth
      id: docker-auth
      uses: 'docker/login-action@v1'
      with:
        username: 'oauth2accesstoken'
        password: '${{ steps.auth.outputs.access_token }}'
        registry: '${{ env.GAR_LOCATION }}-docker.pkg.dev'

    - name: Build and Push Container
      run: |-
         docker tag mydrive_app "${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.SERVICE }}/mydrive-app:latest"
         docker push "${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.SERVICE }}/mydrive-app:latest"

      # END - Docker auth and build
      
    - name: Deploy to Cloud Run
      id: deploy
      uses: google-github-actions/deploy-cloudrun@v0
      with:
        service: 'mydrive-app'
        region: ${{ env.REGION }}
        # NOTE: If using a pre-built image, update the image name here
        image: ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.SERVICE }}/mydrive-app:latest

    
      



